<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Son 50 Deprem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-sA+4p57NH6kM1XkkEdXtpEd1l9OYwP+ajv10A9+RPQc="
      crossorigin=""
    />
    <style>
        #map { height: 250px; margin-bottom: 1rem; }
        .nearby-row, .nearby-cell {
            background-color: #ffcccc !important;
        }
    </style>
</head>
<body style="background:#f4f7fa">
<div class="container my-5">
    <h2 class="text-center mb-4">Son 50 Deprem</h2>

    <div class="mb-3 text-end">
        <a href="{{ url_for('index') }}" class="btn btn-primary">Ana Sayfaya Dön</a>
    </div>

    {% if user_location[0] is not none and near_eq_count > 0 %}
    <div class="alert alert-danger text-center">
        Konumunuza yakın <strong>{{ near_eq_count }}</strong> deprem var.
    </div>
    {% elif user_location[0] is none %}
    <div class="alert alert-info text-center">
        Konum bilgisi alınamadı, yakın depremler işaretlenemedi.
    </div>
    {% else %}
    <div class="alert alert-success text-center">
        Konumunuza yakın deprem bulunmamaktadır.
    </div>
    {% endif %}

    <div class="mb-3">
        <form method="get" action="{{ url_for('last50') }}">
            <div id="map"></div>
            <input type="hidden" id="lat" name="lat" value="{{ user_location[0] or 39.0 }}">
            <input type="hidden" id="lon" name="lon" value="{{ user_location[1] or 35.0 }}">
            <button type="submit" class="btn btn-primary">Konumu Güncelle</button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-sm align-middle">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Yer</th>
                    <th>Büyüklük</th>
                    <th>Derinlik (km)</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in earthquakes %}
                <tr class="{{ 'nearby-row' if eq.near_user else '' }}">
                    <td class="{{ 'nearby-cell' if eq.near_user else '' }}">
                        {% if eq.Date %}
                        {{ eq.Date.strftime("%Y-%m-%d %H:%M:%S") if eq.Date.__class__.__name__ == 'datetime' else eq.Date }}
                        {% endif %}
                    </td>
                    <td class="{{ 'nearby-cell' if eq.near_user else '' }}">{{ eq.Location or "" }}</td>
                    <td class="{{ 'nearby-cell' if eq.near_user else '' }}">{{ eq.Magnitude or "" }}</td>
                    <td class="{{ 'nearby-cell' if eq.near_user else '' }}">{{ eq.Depth or "" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7z7dZyRk1e3h4tSNO4vcK2G5y8JXRqWjv84tIY="
  crossorigin=""
></script>
<script>
  const latInput = document.getElementById('lat');
  const lonInput = document.getElementById('lon');
  const startLat = parseFloat(latInput.value) || 39.0;
  const startLon = parseFloat(lonInput.value) || 35.0;

  const map = L.map('map').setView([startLat, startLon], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
  }).addTo(map);

  const marker = L.marker([startLat, startLon], {draggable:true}).addTo(map);

  marker.on('dragend', function(e) {
      const pos = marker.getLatLng();
      latInput.value = pos.lat.toFixed(6);
      lonInput.value = pos.lng.toFixed(6);
  });

  // Bildirimler için

  let notifiedIds = new Set();

  async function checkNearbyNotifications() {
    try {
      const res = await fetch('/nearby_notifications');
      const data = await res.json();

      data.forEach(eq => {
        const id = eq.location + eq.date;
        if (!notifiedIds.has(id)) {
          notifiedIds.add(id);
          Swal.fire({
            icon: 'warning',
            title: 'Yakınınızda Deprem!',
            html: `<b>${eq.location}</b><br>Büyüklük: ${eq.magnitude}<br>Tarih: ${eq.date}<br>Mesafe: ${eq.distance_km} km`,
            timer: 10000,
            timerProgressBar: true,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
          });
        }
      });
    } catch(e) {
      console.error('Bildirim kontrol hatası:', e);
    }
  }

  setInterval(checkNearbyNotifications, 30000);
  window.onload = checkNearbyNotifications;
</script>
</body>
</html>
