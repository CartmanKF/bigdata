<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Deprem Takip Sistemi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: #f4f7fa;
        }
        .main-card {
            margin: 4% auto;
            padding: 2.2rem 2rem 1.5rem 2rem;
            max-width: 700px;
            border-radius: 1.7rem;
            box-shadow: 0 8px 32px rgba(40,70,150,0.12);
            background: #fff;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #225d90;
            text-align:center;
        }
        .map-frame {
            width: 100%;
            height: 420px;
            border: none;
            border-radius: 1.2rem;
            box-shadow: 0 1px 8px #bbd;
        }
        .btn-custom {
            margin: 12px 10px 5px 0;
            border-radius: 1.3rem;
            padding: 10px 25px;
            font-weight: 500;
            font-size: 1rem;
        }
        .swal2-popup { font-size: 1.12rem !important; }
    </style>
</head>
<body>
    <div class="main-card">
        <h1>Deprem Takip Sistemi</h1>
        <div class="text-center mb-3">
            <button id="showMyEarthquakes" class="btn btn-primary btn-custom">
                Konumuma Yakın Depremleri Göster
            </button>
            <button id="openInteractiveMap" class="btn btn-outline-success btn-custom">
                Haritada Ara
            </button>
        </div>
        <iframe id="mapFrame" class="map-frame" src=""></iframe>
        <div id="info-section" class="mt-3 text-center"></div>
    </div>

<script>
function showMap(lat, lon) {
    const today = (new Date()).toISOString().slice(0,10);
    document.getElementById("mapFrame").src = `/filtered_map?start_date=${today}&end_date=${today}&lat=${lat}&lon=${lon}&radius=100`;
}

function checkNearbyEq(lat, lon) {
    fetch(`/last_realtime_eq`)
    .then(res => res.json())
    .then(eq => {
        if(eq && eq.Latitude && eq.Longitude) {
            const distance = getDistance(lat, lon, eq.Latitude, eq.Longitude);
            if (distance < 100) {
                Swal.fire({
                    title: 'Yakınınızda Deprem!',
                    html: `<b>${eq.Location}</b><br>${eq.Date}<br><b>M ${eq.Magnitude}</b>`,
                    icon: 'warning',
                    confirmButtonText: 'Tamam',
                    showCloseButton: true
                });
            }
        }
    });
}

function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    var R = 6371;
    var dLat = toRad(lat2-lat1);
    var dLon = toRad(lon2-lon1);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

window.onload = function() {
    // Otomatik konum
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            showMap(lat, lon);
            checkNearbyEq(lat, lon);
            window._mylat = lat;
            window._mylon = lon;
        }, function() {
            Swal.fire("Konum izni gerekli!").then(()=>window.location.reload());
        });
    } else {
        alert("Tarayıcınız konum özelliğini desteklemiyor!");
    }
};

document.getElementById("showMyEarthquakes").onclick = function() {
    if (window._mylat && window._mylon) {
        showMap(window._mylat, window._mylon);
        checkNearbyEq(window._mylat, window._mylon);
    } else {
        Swal.fire("Lütfen konum izni verin.");
    }
};
document.getElementById("openInteractiveMap").onclick = function() {
    window.location.href = '/interactive_map';
};
</script>
</body>
</html>
